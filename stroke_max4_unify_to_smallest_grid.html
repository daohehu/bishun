<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>笔顺展示</title>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.7.3/dist/hanzi-writer.min.js"></script>
  <style>
    :root{
      --base:130px;           /* 会在运行时按“最小格”动态覆盖 */
      --bg:#fff;
      --line:rgba(0,0,0,.14);
      --grid:rgba(0,0,0,.18);
      --text:#111827;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
    }

    /* 顶部搜索 */
    .topbar{
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
      position: sticky;
      top: 0;
      z-index: 10;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
    }
    .topbar input{
      width:100%;
      max-width:420px;
      padding:10px 12px;
      font-size:16px;
      border-radius:10px;
      border:1px solid var(--line);
      outline:none;
    }

    .page{
      padding: 14px 12px 22px;
      display:flex;
      justify-content:center;
    }

    /* 多行结构：每行一个字 */
    .stack{
      width:100%;
      max-width:1400px;
      display:grid;
      grid-template-rows: repeat(4, auto); /* 最多 4 行 */
      gap:16px;
    }
    .row{
      display:flex;
      align-items:center;
      gap:16px;
      justify-content:flex-start;
      flex-wrap:nowrap;
    }

    /* 动态：按 --base 统一 */
    .dynWrap{
      width: var(--base);
      flex: 0 0 auto;
      display:grid;
      gap: 8px;
      justify-items:center;
    }
    .box{
      width: var(--base);
      height: var(--base);
      border: 1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      position: relative;
      display:grid;
      place-items:center;
      overflow:hidden;
    }

    /* 播放暂停按钮 */
    .ppBtn{
      width: var(--base);
      border: 1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor:pointer;
      line-height: 1;
      user-select:none;
    }
    .ppBtn:active{ transform: translateY(1px); }

    /* 田字格：动态框 */
    .box::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 12px;
      background:
        linear-gradient(to right, transparent 49.5%, var(--grid) 49.5%, var(--grid) 50.5%, transparent 50.5%),
        linear-gradient(to bottom, transparent 49.5%, var(--grid) 49.5%, var(--grid) 50.5%, transparent 50.5%),
        linear-gradient(135deg, transparent 49.7%, rgba(0,0,0,.10) 49.7%, rgba(0,0,0,.10) 50.3%, transparent 50.3%),
        linear-gradient(45deg, transparent 49.7%, rgba(0,0,0,.10) 49.7%, rgba(0,0,0,.10) 50.3%, transparent 50.3%);
      pointer-events:none;
      opacity:.75;
    }

    .dynTarget{
      width: calc(var(--base) - 12px);
      height: calc(var(--base) - 12px);
      position: relative;
      z-index: 1;
    }

    /* 分步：一行横排（最多 8 格；超出自动缩小），但每次输入会统一到“最小格” */
    .stepStrip{
      display:flex;
      flex-direction:row;
      gap:12px;
      align-items:center;
      flex-wrap:nowrap;
      min-width: 0;
    }

    .stepCell{
      width: var(--base);
      height: var(--base);
      border: 1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      position: relative;
      display:grid;
      place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }

    /* 田字格：分步格 */
    .stepCell::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 12px;
      background:
        linear-gradient(to right, transparent 49.5%, var(--grid) 49.5%, var(--grid) 50.5%, transparent 50.5%),
        linear-gradient(to bottom, transparent 49.5%, var(--grid) 49.5%, var(--grid) 50.5%, transparent 50.5%),
        linear-gradient(135deg, transparent 49.7%, rgba(0,0,0,.10) 49.7%, rgba(0,0,0,.10) 50.3%, transparent 50.3%),
        linear-gradient(45deg, transparent 49.7%, rgba(0,0,0,.10) 49.7%, rgba(0,0,0,.10) 50.3%, transparent 50.3%);
      pointer-events:none;
      opacity:.75;
    }

    .stepCell svg{
      display:block;
      position:relative;
      z-index:1;
    }

    @media (max-width: 980px){
      body{ overflow-x:auto; } /* 小屏允许横向滚动，保证一行分步不断行 */
    }
  </style>
</head>
<body>

  <div class="topbar">
    <input id="searchInput" placeholder="输入汉字，例如：你好学习生活" />
  </div>

  <div class="page">
    <div class="stack" id="stack"></div>
  </div>

<script>
  function isLikelyHanzi(ch) {
    const code = ch.codePointAt(0);
    return (
      (code >= 0x4E00 && code <= 0x9FFF) ||
      (code >= 0x3400 && code <= 0x4DBF) ||
      (code >= 0xF900 && code <= 0xFAFF)
    );
  }

  const MAX_CHARS = 4;   // 最多展示 4 个字
  const MAX_PER_ROW = 8; // 分步一行最多 8 笔（超出缩小）
  const BASE_MAX = 130;  // 最大格
  const BASE_MIN = 70;   // 最小格下限

  function calcSuggestedSize(strokeCount){
    if (strokeCount <= MAX_PER_ROW) return BASE_MAX;
    const scale = MAX_PER_ROW / strokeCount;
    return Math.max(BASE_MIN, Math.floor(BASE_MAX * scale));
  }

  function setUnifiedBase(px){
    document.documentElement.style.setProperty("--base", px + "px");
  }

  function buildStepSvg(charData, k, size){
    const padding = Math.max(8, Math.floor(size*0.08));
    const strokes = charData.strokes || [];
    const t = HanziWriter.getScalingTransform(size, size, padding);

    const ghost = strokes.map((d,i)=> i<k ? "" :
      `<path d="${d}" fill="none" stroke="rgba(17,24,39,.14)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>`
    ).join("");

    const done = strokes.map((d,i)=> i>=k ? "" :
      `<path d="${d}" fill="#111827"/>`
    ).join("");

    return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
      <g transform="${t.transform}">
        ${ghost}${done}
      </g>
    </svg>`;
  }

  // 动态：播放一次后暂停；按钮切换播放/暂停（播放时循环）
  function makePlayer(targetId, ch, charData, basePx){
    const writer = HanziWriter.create(targetId, ch, {
      width: basePx-12,
      height: basePx-12,
      padding: Math.max(8, Math.floor(basePx*0.08)),
      showOutline: true,
      outlineColor:"rgba(17,24,39,.12)",
      strokeColor:"#111827",
      delayBetweenStrokes:120,
      charDataLoader:()=>Promise.resolve(charData)
    });

    let playing = false;
    let token = 0;

    async function playOnce(){
      writer.hideCharacter();
      try{ await writer.animateCharacter(); }catch(e){}
    }

    async function loop(){
      const my = ++token;
      while (playing && my === token){
        await playOnce();
        if (!playing || my !== token) break;
        await new Promise(r=>setTimeout(r, 420));
      }
    }

    function setPlaying(v){
      playing = v;
      token++; // 终止旧循环
      if (playing) loop();
    }

    // 初始：播放一次，然后停住
    playOnce().then(()=>setPlaying(false));

    return { setPlaying, get playing(){ return playing; } };
  }

  async function render(text){
    const stack = document.getElementById("stack");
    stack.innerHTML = "";

    const chars = Array.from(text).filter(isLikelyHanzi).slice(0, MAX_CHARS);

    // 先加载所有字的数据，计算“最小建议尺寸”，然后统一全局格子大小
    const dataList = await Promise.all(chars.map(async (ch) => {
      try{
        const d = await HanziWriter.loadCharacterData(ch);
        const count = (d.strokes || []).length;
        return { ch, d, count, suggested: calcSuggestedSize(count) };
      }catch(e){
        return { ch, d: null, count: 0, suggested: BASE_MAX };
      }
    }));

    const valid = dataList.filter(x => x.d);
    const unified = valid.length ? Math.min(...valid.map(x => x.suggested)) : BASE_MAX;
    setUnifiedBase(unified);

    // 补足到 4 行，占位保持布局
    while(dataList.length < MAX_CHARS) dataList.push({ ch: null, d: null, count: 0, suggested: unified });

    for(let i=0;i<MAX_CHARS;i++){
      const item = dataList[i];
      const row = document.createElement("div");
      row.className = "row";

      const dynWrap = document.createElement("div");
      dynWrap.className = "dynWrap";

      const dynBox = document.createElement("div");
      dynBox.className = "box";
      const dynId = `dyn_${i}_${Date.now()}`;
      dynBox.innerHTML = item.ch ? `<div id="${dynId}" class="dynTarget"></div>` : "";

      const ppBtn = document.createElement("button");
      ppBtn.className = "ppBtn";
      ppBtn.type = "button";
      ppBtn.textContent = "播放";

      dynWrap.append(dynBox, ppBtn);

      const stepStrip = document.createElement("div");
      stepStrip.className = "stepStrip";

      row.append(dynWrap, stepStrip);
      stack.appendChild(row);

      if(!item.ch || !item.d){
        ppBtn.style.visibility = "hidden";
        continue;
      }

      const player = makePlayer(dynId, item.ch, item.d, unified);
      ppBtn.textContent = "播放";

      ppBtn.onclick = () => {
        if (player.playing){
          player.setPlaying(false);
          ppBtn.textContent = "播放";
        }else{
          player.setPlaying(true);
          ppBtn.textContent = "暂停";
        }
      };

      // 分步：格子也统一到 unified（最小格），保证所有田字格同尺寸
      const count = item.count;
      for(let k=1;k<=count;k++){
        const c = document.createElement("div");
        c.className = "stepCell";
        c.innerHTML = buildStepSvg(item.d, k, unified);
        stepStrip.appendChild(c);
      }
    }
  }

  const input = document.getElementById("searchInput");
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter") render(input.value);
  });

  render("你好学习生活");
</script>
</body>
</html>
